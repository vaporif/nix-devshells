name: "check"

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ !startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/main' }}

jobs:
  nix:
    strategy:
      matrix:
        include:
          - os: macos-latest
            system: aarch64-darwin
          - os: ubuntu-latest
            system: x86_64-linux
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - uses: cachix/cachix-action@v16
        with:
          name: vaporif
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Check nix flake
        run: nix flake check

      - name: Check formatting (alejandra)
        run: nix run nixpkgs#alejandra -- --check .

      - name: Build devshells
        run: |
          for shell in default rust go solana; do
            nix build ".#devShells.${{ matrix.system }}.${shell}"
          done

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install linters
        run: cargo binstall -y typos-cli taplo-cli

      - name: Run typos
        run: typos

      - name: Check TOML formatting
        run: taplo fmt --check

      - name: Run shellcheck
        run: shellcheck -S style -o all scripts/*.sh

      - name: Run actionlint
        uses: raven-actions/actionlint@v2

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
